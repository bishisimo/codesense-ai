<template>
  <div class="merge-requests-container">
    <!-- È°µÈù¢Ê†áÈ¢ò -->
    <div class="page-header">
      <!-- È¢ÑÁïôÁ©∫Èó¥Ôºå‰øùÊåÅÂ∏ÉÂ±Ä‰∏ÄËá¥ -->
    </div>
    
    <!-- È°πÁõÆÈÄâÊã©Âô® -->
    <div class="project-selector-container">
      <div class="project-selector-content">
        <div class="selector-label">
          <el-icon class="label-icon"><Folder /></el-icon>
          <span>ÈÄâÊã©È°πÁõÆ</span>
        </div>
        <el-select
          v-model="selectedProjectId"
          placeholder="ËØ∑ÈÄâÊã©È°πÁõÆ"
          clearable
          @change="handleProjectChange"
          class="modern-project-select"
        >
          <el-option
            v-for="project in projects"
            :key="project.id"
            :label="project.name"
            :value="project.id"
            class="project-option"
          >
            <div class="project-option-content">
              <div class="project-info">
                <div class="project-name">{{ project.name }}</div>
                <div class="project-meta">
                  <span class="project-id">#{{ project.gitlab_id }}</span>
                </div>
              </div>
              <div class="project-indicator">
                <div class="indicator-dot"></div>
              </div>
            </div>
          </el-option>
        </el-select>
        <!-- ÂêåÊ≠•È°πÁõÆÊåâÈíÆ -->
        <el-button 
          v-if="selectedProjectId"
          type="primary" 
          @click="syncProject" 
          :loading="syncLoading" 
          :disabled="currentProjectSyncStatus?.status === 'running'"
          size="small"
          class="sync-project-btn"
        >
          <el-icon v-if="!currentProjectSyncStatus || currentProjectSyncStatus.status !== 'running'"><Refresh /></el-icon>
          <span v-if="!currentProjectSyncStatus">ÂêåÊ≠•È°πÁõÆ</span>
          <span v-else-if="currentProjectSyncStatus.status === 'running'">
            ÂêåÊ≠•‰∏≠...
          </span>
          <span v-else>ÂêåÊ≠•È°πÁõÆ</span>
        </el-button>
      </div>
    </div>

    <!-- Á≠õÈÄâË°®Âçï -->
    <div class="filter-container">
      <div class="filter-grid">
        <div class="filter-item">
          <el-input
            v-model="filterForm.title"
            placeholder="ÊêúÁ¥¢Ê†áÈ¢ò"
            clearable
            @input="debouncedLoadData"
            @keyup.enter="loadData"
            class="compact-input"
          >
            <template #prefix>
              <el-icon><Document /></el-icon>
            </template>
          </el-input>
        </div>
        <div class="filter-item">
          <el-input
            v-model="filterForm.author"
            placeholder="ÊêúÁ¥¢‰ΩúËÄÖ"
            clearable
            @input="debouncedLoadData"
            @keyup.enter="loadData"
            class="compact-input"
          >
            <template #prefix>
              <el-icon><User /></el-icon>
            </template>
          </el-input>
        </div>
        <div class="filter-item">
          <el-input
            v-model="filterForm.source_branch"
            placeholder="ÊêúÁ¥¢Ê∫êÂàÜÊîØ"
            clearable
            @input="debouncedLoadData"
            @keyup.enter="loadData"
            class="compact-input"
          >
            <template #prefix>
              <el-icon><Share /></el-icon>
            </template>
          </el-input>
        </div>
        <div class="filter-item">
          <el-input
            v-model="filterForm.target_branch"
            placeholder="ÊêúÁ¥¢ÁõÆÊ†áÂàÜÊîØ"
            clearable
            @input="debouncedLoadData"
            @keyup.enter="loadData"
            class="compact-input"
          >
            <template #prefix>
              <el-icon><Share /></el-icon>
            </template>
          </el-input>
        </div>
        <div class="filter-item">
          <el-select
            v-model="filterForm.state"
            placeholder="ÈÄâÊã©MRÁä∂ÊÄÅ"
            clearable
            @change="debouncedLoadData"
            class="compact-input"
          >
            <el-option label="ÂÖ®ÈÉ®" value="" />
            <el-option label="ÂºÄÂèë" value="opened" />
            <el-option label="ÂêàÂπ∂" value="merged" />
            <el-option label="ÂÖ≥Èó≠" value="closed" />
          </el-select>
        </div>
        <div class="filter-actions">
          <el-button type="primary" @click="loadData" :loading="loading" size="small">
            <el-icon><Search /></el-icon>
            ÊêúÁ¥¢
          </el-button>
          <el-button @click="resetFilter" size="small">
            <el-icon><RefreshLeft /></el-icon>
            ÈáçÁΩÆ
          </el-button>
        </div>
      </div>
    </div>
    
    <!-- Êï∞ÊçÆË°®Ê†º -->
    <el-card class="table-card" shadow="never">
      <el-table 
        v-loading="tableLoading"
        :data="tableData"
        style="width: 100%"
        @sort-change="handleSortChange"
        class="modern-table"
        :header-cell-style="{ background: '#f8f9fa', color: '#606266' }"
        :max-height="tableMaxHeight"
        stripe
      >
        <!-- ÂÆ°Êü•Áä∂ÊÄÅÂàó -->
        <el-table-column label="ÂÆ°Êü•Áä∂ÊÄÅ" width="180" fixed="left" align="center" header-align="center">
          <template #default="{ row }">
            <el-dropdown 
              trigger="click" 
              placement="bottom-start"
              :disabled="reviewingIds.has(row.id)"
              @command="(command: string) => handleReviewCommand(command, row)"
            >
              <div class="status-cell" :class="{ 
                'clickable': canReview(row) || row.is_reviewing === 1,
                'reviewing': row.is_reviewing === 1
              }">
                <div class="status-icon" :class="getReviewStatusClass(row)">
                  <el-icon v-if="getReviewStatusDesc(row) === 'Ê≠£Âú®ÂÆ°Êü•‰∏≠'"><Loading /></el-icon>
                  <el-icon v-else-if="getReviewStatusDesc(row) === 'ÂÆ°Êü•ÊúÄÊñ∞'"><Check /></el-icon>
                  <el-icon v-else-if="getReviewStatusDesc(row) === 'ÂÆ°Êü•ËøáÊó∂'"><RefreshLeft /></el-icon>
                  <el-icon v-else-if="getReviewStatusDesc(row) === 'Á≠âÂæÖÂÆ°Êü•'"><Clock /></el-icon>
                  <el-icon v-else><InfoFilled /></el-icon>
                </div>
                <div class="status-text">
                  <div class="status-label">{{ getReviewStatusText(row) }}</div>
                  <div class="status-desc">{{ getReviewStatusDesc(row) }}</div>
                </div>
              </div>
              <template #dropdown>
                <el-dropdown-menu>
                  <el-dropdown-item command="direct">
                    <span style="font-size: 16px; margin-right: 8px;">üöÄ</span>
                    Áõ¥Êé•ÂÆ°Êü•
                  </el-dropdown-item>
                  <el-dropdown-item command="custom">
                    <span style="font-size: 16px; margin-right: 8px;">‚öôÔ∏è</span>
                    Ëá™ÂÆö‰πâÂÆ°Êü•
                  </el-dropdown-item>
                </el-dropdown-menu>
              </template>
            </el-dropdown>
          </template>
        </el-table-column>
        
        <!-- ËØÑÂàÜÂàó -->
        <el-table-column label="ËØÑÂàÜ" width="100" fixed="left" align="center" header-align="center">
          <template #default="{ row }">
            <div class="score-cell">
              <!-- Âè™ÊúâÊúâreview_id‰∏îÊúâËØÑÂàÜÁöÑÊâçÊòæÁ§∫‰∏∫ÂèØÁÇπÂáª -->
              <div v-if="row.review_score !== null && row.review_id && row.review_id > 0" 
                   class="score-badge clickable" 
                   :class="getScoreClass(row.review_score)"
                   @click="showReviewReport(row)"
                   title="ÁÇπÂáªÊü•ÁúãÂÆ°Êü•Êä•Âëä">
                <span class="score-value">{{ row.review_score }}</span>
                <el-icon class="score-icon"><View /></el-icon>
              </div>
              <!-- ÊúâËØÑÂàÜ‰ΩÜÊ≤°Êúâreview_idÁöÑÊòæÁ§∫‰∏∫‰∏çÂèØÁÇπÂáª -->
              <div v-else-if="row.review_score !== null" 
                   class="score-badge" 
                   :class="getScoreClass(row.review_score)">
                <span class="score-value">{{ row.review_score }}</span>
              </div>
              <div v-else class="score-empty">
                <el-icon><Minus /></el-icon>
              </div>
            </div>
          </template>
        </el-table-column>
        
        <!-- ÂÖ∂‰ªñÂàó -->
        <el-table-column prop="gitlab_id" label="MR ID" width="80" align="center" header-align="center">
          <template #default="{ row }">
            <div class="mr-id-cell">
              <span 
                class="mr-id-link" 
                @click="openGitLabInNewTab(row)"
                title="ÁÇπÂáªÂú®Êñ∞Ê†áÁ≠æÈ°µ‰∏≠ÊâìÂºÄGitLabÈ°µÈù¢"
              >
                #{{ row.gitlab_id }}
                <el-icon class="link-icon"><Link /></el-icon>
              </span>
            </div>
          </template>
        </el-table-column>
        <el-table-column prop="title" label="Ê†áÈ¢ò" min-width="200" align="center" header-align="center" show-overflow-tooltip />
        <el-table-column prop="author" label="ÂºÄÂèëËÄÖ" width="120" align="center" header-align="center" />
        <el-table-column prop="source_branch" label="Ê∫êÂàÜÊîØ" width="150" align="center" header-align="center" show-overflow-tooltip />
        <el-table-column prop="target_branch" label="ÁõÆÊ†áÂàÜÊîØ" width="150" align="center" header-align="center" show-overflow-tooltip />
        <el-table-column prop="state" label="Áä∂ÊÄÅ" width="80" align="center" header-align="center">
          <template #default="{ row }">
            <el-tag :type="getStateType(row.state)" size="small" class="state-tag">
              {{ getStateText(row.state) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="commits_count" label="Êèê‰∫§Êï∞" width="80" align="center" header-align="center" />
        <el-table-column label="ÊîπÂä®Ë°åÊï∞" width="120" align="center" header-align="center">
          <template #default="{ row }">
            <span v-if="row.additions_count > 0 || row.deletions_count > 0">
              <span class="additions">+{{ row.additions_count }}</span>
              <span class="deletions">-{{ row.deletions_count }}</span>
            </span>
            <span v-else class="no-changes">0</span>
          </template>
        </el-table-column>
        <el-table-column label="Commit ID" width="100" align="center" header-align="center">
          <template #default="{ row }">
            <div v-if="row.commit_id" class="commit-id-cell">
              <span class="commit-id-text">{{ row.commit_id }}</span>
            </div>
            <span v-else class="no-commit">-</span>
          </template>
        </el-table-column>
        <el-table-column prop="mr_created_at" label="MRÂàõÂª∫Êó∂Èó¥" width="180" align="center" header-align="center" sortable="custom">
          <template #default="{ row }">
            {{ formatDate(row.mr_created_at) }}
          </template>
        </el-table-column>
        <el-table-column prop="mr_updated_at" label="MRÊõ¥Êñ∞Êó∂Èó¥" width="180" align="center" header-align="center" sortable="custom">
          <template #default="{ row }">
            {{ formatDate(row.mr_updated_at) }}
          </template>
        </el-table-column>
        
        <!-- Êìç‰ΩúÂàó -->
        <el-table-column label="Êìç‰Ωú" width="120" fixed="right" align="center" header-align="center">
          <template #default="{ row }">
            <div class="action-buttons">
              <el-button 
                type="warning" 
                size="small" 
                :loading="syncingIds.has(row.id)"
                @click="handleSync(row)"
                class="action-btn"
              >
                <el-icon v-if="!syncingIds.has(row.id)"><Refresh /></el-icon>
                {{ syncingIds.has(row.id) ? 'ÂêåÊ≠•‰∏≠...' : 'ÂêåÊ≠•' }}
              </el-button>
            </div>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- ÂàÜÈ°µ -->
      <div class="pagination-container">
        <div class="pagination-row">
          <div class="pagination-info">
            <span class="pagination-text">
              ÂÖ± {{ pagination.total }} Êù°ËÆ∞ÂΩïÔºåÊØèÈ°µÊòæÁ§∫ 10 Êù°
            </span>
          </div>
          <div class="pagination-controls">
            <el-pagination
              v-model:current-page="pagination.page"
              :total="pagination.total"
              :page-size="10"
              layout="prev, pager, next, jumper"
              @current-change="handleCurrentChange"
              class="modern-pagination"
            />
          </div>
        </div>
      </div>
    </el-card>




  </div>

  <!-- Ëá™ÂÆö‰πâÂÆ°Êü•ÂØπËØùÊ°Ü -->
  <CustomReviewDialog
    v-model="showCustomReviewDialog"
    :mr-id="currentReviewMR?.id || 0"
    :mr-title="currentReviewMR?.title || ''"
    :is-reviewing="currentReviewMR?.is_reviewing === 1"
    @confirm="handleCustomReviewConfirm"
  />
</template>

<script setup lang="ts">
import { ref, reactive, computed, onMounted, onUnmounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { 
  Document, 
  Refresh, 
  Search, 
  RefreshLeft, 
  Folder, 
  User, 
  Share,
  Clock,
  Check,
  InfoFilled,
  Minus,
  Edit,
  Loading,
  Close,
  View,
  ArrowRight,
  Link,
  ArrowDown,
  Setting
} from '@element-plus/icons-vue'
import dayjs from 'dayjs'
import { adminApi, type MergeRequestListItem, type Project } from '@/api/admin'

import { useAuthStore } from '@/stores/auth'
import CustomReviewDialog from '@/components/CustomReviewDialog.vue'

const router = useRouter()
const loading = ref(false)
const tableLoading = ref(false) // ‰∏ìÈó®Áî®‰∫éË°®Ê†ºÁöÑloadingÁä∂ÊÄÅ
const syncLoading = ref(false) // ÂêåÊ≠•È°πÁõÆÁöÑloadingÁä∂ÊÄÅ
const reviewingIds = ref(new Set<number>())
const syncingIds = ref(new Set<number>())

// Ë°®Ê†ºÈ´òÂ∫¶ÊéßÂà∂
const tableMaxHeight = ref(600)

// Èò≤ÊäñÁõ∏ÂÖ≥
let loadDataTimeout: number | null = null

// ÂÆöÊó∂Âà∑Êñ∞Áõ∏ÂÖ≥
const pollingIntervals = ref(new Map<number, number>())
const pollingCounts = ref(new Map<number, number>()) // ËÆ∞ÂΩïÊØè‰∏™MRÁöÑËΩÆËØ¢Ê¨°Êï∞
const maxPollingCount = 60 // ÊúÄÂ§ßËΩÆËØ¢Ê¨°Êï∞Ôºà3ÂàÜÈíüÔºâ

// ‰ªªÂä°Áä∂ÊÄÅËΩÆËØ¢Áõ∏ÂÖ≥
const taskPollingIntervals = new Map<string, number>()
const taskStatuses = ref(new Map<string, { status: string; progress: number; message: string }>())

// Êï∞ÊçÆÁä∂ÊÄÅÊØîËæÉÁõ∏ÂÖ≥
const lastDataSnapshot = ref<Map<number, any>>(new Map())
const dataChangeCount = ref(0)

// Ëá™ÂÆö‰πâÂÆ°Êü•ÂØπËØùÊ°ÜÁõ∏ÂÖ≥
const showCustomReviewDialog = ref(false)
const currentReviewMR = ref<MergeRequestListItem | null>(null)

// Ëé∑ÂèñÂΩìÂâçÈ°πÁõÆÁöÑÂêåÊ≠•Áä∂ÊÄÅ
const currentProjectSyncStatus = computed(() => {
  for (const [taskId, status] of taskStatuses.value) {
    if (status.status === 'running' || status.status === 'pending') {
      return status
    }
  }
  return null
})

// Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠È°πÁõÆÁöÑÂêçÁß∞
const currentProjectName = computed(() => {
  if (!selectedProjectId.value) return null
  const project = projects.value.find(p => p.id === selectedProjectId.value)
  return project?.name || null
})



// GitLabÈìæÊé•Áõ∏ÂÖ≥
const openGitLabInNewTab = (row: MergeRequestListItem) => {
  const gitlabUrl = `${row.project_web_url}/-/merge_requests/${row.gitlab_id}`
  window.open(gitlabUrl, '_blank')
}

const filterForm = reactive({
  title: '',
  author: '',
  source_branch: '',
  target_branch: '',
  state: ''
})

const pagination = reactive({
  page: 1,
  size: 10,
  total: 0
})

const sortInfo = reactive({
  sort_by: 'mr_created_at',
  sort_order: 'desc'
})

const tableData = ref<MergeRequestListItem[]>([])

// È°πÁõÆÁõ∏ÂÖ≥
const projects = ref<Project[]>([])
const selectedProjectId = ref<number | null>(null)

// ‰ªélocalStorageÂä†ËΩΩÈÄâ‰∏≠ÁöÑÈ°πÁõÆ
const loadSelectedProject = () => {
  const savedProjectId = localStorage.getItem('selectedProjectId')
  if (savedProjectId) {
    selectedProjectId.value = parseInt(savedProjectId)
  }
}

// ‰øùÂ≠òÈÄâ‰∏≠ÁöÑÈ°πÁõÆÂà∞localStorage
const saveSelectedProject = (projectId: number | null) => {
  if (projectId) {
    localStorage.setItem('selectedProjectId', projectId.toString())
  } else {
    localStorage.removeItem('selectedProjectId')
  }
}

// ‰øùÂ≠òÂàÜÈ°µÁä∂ÊÄÅÂà∞localStorage
const savePaginationState = () => {
  const paginationState = {
    page: pagination.page,
    size: pagination.size,
    total: pagination.total,
    filterForm: { ...filterForm },
    sortInfo: { ...sortInfo },
    selectedProjectId: selectedProjectId.value
  }
  localStorage.setItem('mergeRequestsPaginationState', JSON.stringify(paginationState))
}

// ‰ªélocalStorageÊÅ¢Â§çÂàÜÈ°µÁä∂ÊÄÅ
const restorePaginationState = () => {
  try {
    const savedState = localStorage.getItem('mergeRequestsPaginationState')
    if (savedState) {
      const state = JSON.parse(savedState)
      pagination.page = state.page || 1
      pagination.size = state.size || 10
      pagination.total = state.total || 0
      
      // ÊÅ¢Â§çÁ≠õÈÄâÊù°‰ª∂
      if (state.filterForm) {
        Object.assign(filterForm, state.filterForm)
      }
      
      // ÊÅ¢Â§çÊéíÂ∫è‰ø°ÊÅØ
      if (state.sortInfo) {
        Object.assign(sortInfo, state.sortInfo)
      }
      
      // ÊÅ¢Â§çÈÄâ‰∏≠ÁöÑÈ°πÁõÆ
      if (state.selectedProjectId) {
        selectedProjectId.value = state.selectedProjectId
      }
      
      // Ê∏ÖÈô§‰øùÂ≠òÁöÑÁä∂ÊÄÅÔºåÈÅøÂÖçÂΩ±ÂìçÂÖ∂‰ªñÊìç‰Ωú
      localStorage.removeItem('mergeRequestsPaginationState')
      return true
    }
  } catch (error) {
    console.error('ÊÅ¢Â§çÂàÜÈ°µÁä∂ÊÄÅÂ§±Ë¥•:', error)
    localStorage.removeItem('mergeRequestsPaginationState')
  }
  return false
}

// Âä†ËΩΩÈ°πÁõÆÂàóË°®
const loadProjects = async () => {
  try {
    const response = await adminApi.getProjects()
    projects.value = response.items
  } catch (error) {
    console.error('Âä†ËΩΩÈ°πÁõÆÂàóË°®Â§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÈ°πÁõÆÂàóË°®Â§±Ë¥•')
  }
}

// Â§ÑÁêÜÈ°πÁõÆÈÄâÊã©ÂèòÂåñ
const handleProjectChange = (projectId: number | null) => {
  saveSelectedProject(projectId)
  pagination.page = 1 // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
  // È°πÁõÆÂèòÂåñÊó∂Á´ãÂç≥Âä†ËΩΩÔºå‰∏ç‰ΩøÁî®Èò≤Êäñ
  loadData(true)
}

// ÂêåÊ≠•ÊåáÂÆöÈ°πÁõÆÔºàÂºÇÊ≠•‰ªªÂä°Ê®°ÂºèÔºâ
const syncProject = async () => {
  if (!selectedProjectId.value) {
    ElMessage.warning('ËØ∑ÂÖàÈÄâÊã©È°πÁõÆ')
    return
  }

  try {
    syncLoading.value = true
    const result = await adminApi.syncProject(selectedProjectId.value)
    
    if (result.success) {
      const projectName = currentProjectName.value || `È°πÁõÆ ${selectedProjectId.value}`
      ElMessage.success(`${projectName} ÂêåÊ≠•‰ªªÂä°Â∑≤Êèê‰∫§ÔºåÊ≠£Âú®ÂêéÂè∞ÊâßË°å`)
      // ÂºÄÂßãËΩÆËØ¢‰ªªÂä°Áä∂ÊÄÅ
      if (result.task_id) {
        // ÂàùÂßãÂåñ‰ªªÂä°Áä∂ÊÄÅ
        taskStatuses.value.set(result.task_id, { 
          status: 'pending', 
          progress: 0, 
          message: '‰ªªÂä°Â∑≤Êèê‰∫§ÔºåÁ≠âÂæÖÊâßË°å...' 
        })
        pollTaskStatus(result.task_id)
      }
    } else {
      ElMessage.error(result.message || 'Êèê‰∫§ÂêåÊ≠•‰ªªÂä°Â§±Ë¥•')
    }
  } catch (error) {
    console.error('ÂêåÊ≠•È°πÁõÆÂ§±Ë¥•:', error)
    ElMessage.error('ÂêåÊ≠•È°πÁõÆÂ§±Ë¥•')
  } finally {
    syncLoading.value = false
  }
}

// Èò≤ÊäñÁöÑloadDataÂáΩÊï∞
const debouncedLoadData = () => {
  if (loadDataTimeout) {
    clearTimeout(loadDataTimeout)
  }
  loadDataTimeout = setTimeout(() => {
    loadData(true)
  }, 300) // 300msÈò≤ÊäñÂª∂Ëøü
}

// ÊØîËæÉÊï∞ÊçÆÊòØÂê¶ÂèëÁîüÂèòÂåñ
const hasDataChanged = (newData: MergeRequestListItem[], oldData: Map<number, any>): boolean => {
  if (newData.length !== oldData.size) {
    return true
  }
  
  for (const item of newData) {
    const oldItem = oldData.get(item.id)
    if (!oldItem) {
      return true
    }
    
    // ÊØîËæÉÂÖ≥ÈîÆÂ≠óÊÆµÔºåÈáçÁÇπÂÖ≥Ê≥®ÂÆ°Êü•Áõ∏ÂÖ≥Áä∂ÊÄÅ
    const keyFields = [
      'is_reviewing', 
      'is_reviewed', 
      'is_latest_reviewed', 
      'is_failed',
      'review_status', 
      'review_score',
      'review_id',
      'last_commit_sha', 
      'state',
      'updated_at',
      'mr_updated_at'
    ]
    for (const field of keyFields) {
      if ((item as any)[field] !== (oldItem as any)[field]) {
        return true
      }
    }
  }
  
  return false
}

// Êõ¥Êñ∞Êï∞ÊçÆÂø´ÁÖß
const updateDataSnapshot = (data: MergeRequestListItem[]) => {
  const snapshot = new Map<number, any>()
  data.forEach(item => {
    snapshot.set(item.id, {
      is_reviewing: item.is_reviewing,
      is_reviewed: item.is_reviewed,
      is_latest_reviewed: item.is_latest_reviewed,
      is_failed: item.is_failed,
      review_status: item.review_status,
      review_score: item.review_score,
      review_id: item.review_id,
      mr_updated_at: item.mr_updated_at,
      last_commit_sha: item.last_commit_sha,
      state: item.state
    })
  })
  lastDataSnapshot.value = snapshot
}

const loadData = async (forceRefresh: boolean = false) => {
  try {
    tableLoading.value = true
    const params: Record<string, any> = {
      page: pagination.page,
      size: pagination.size,
      ...filterForm,
      ...sortInfo
    }
    
    // Ê∑ªÂä†È°πÁõÆIDÁ≠õÈÄâ
    if (selectedProjectId.value) {
      params.project_id = selectedProjectId.value
    }
    
    // ËøáÊª§Á©∫ÂÄº
    Object.keys(params).forEach(key => {
      if (params[key] === '' || params[key] === null || params[key] === undefined) {
        delete params[key]
      }
    })
    
    const response = await adminApi.getMergeRequests(params)
    
    // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÂèëÁîüÂèòÂåñ
    if (!forceRefresh && hasDataChanged(response.items, lastDataSnapshot.value)) {
      dataChangeCount.value++
      console.log(`Êï∞ÊçÆÂèëÁîüÂèòÂåñÔºåÁ¨¨${dataChangeCount.value}Ê¨°Êõ¥Êñ∞`)
    } else if (!forceRefresh) {
      console.log('Êï∞ÊçÆÊú™ÂèëÁîüÂèòÂåñÔºåË∑≥ËøáÂâçÁ´ØÊõ¥Êñ∞')
      return
    }
    
    tableData.value = response.items
    pagination.total = response.total
    
    // Êõ¥Êñ∞Êï∞ÊçÆÂø´ÁÖß
    updateDataSnapshot(response.items)
    
    // Ë∞ÉËØï‰ø°ÊÅØ
    console.log('APIËØ∑Ê±ÇÂèÇÊï∞:', params)
    console.log('APIÂìçÂ∫î:', {
      total: response.total,
      page: response.page,
      size: response.size,
      pages: response.pages,
      itemsCount: response.items.length
    })
    
    // Á°Æ‰øùÈ°µÁ†Å‰∏çË∂ÖÂá∫ËåÉÂõ¥
    const totalPages = Math.ceil(response.total / pagination.size)
    if (pagination.page > totalPages && totalPages > 0) {
      pagination.page = totalPages
      // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
      await loadData(true)
      return
    }
  } catch (error) {
    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error)
    ElMessage.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•')
  } finally {
    tableLoading.value = false
  }
}



const resetFilter = () => {
  Object.keys(filterForm).forEach(key => {
    (filterForm as Record<string, string>)[key] = ''
  })
  pagination.page = 1
  loadData(true)
}

const handleSortChange = ({ prop, order }: { prop: string; order: string }) => {
  if (order) {
    sortInfo.sort_by = prop
    sortInfo.sort_order = order === 'ascending' ? 'asc' : 'desc'
  } else {
    sortInfo.sort_by = 'mr_created_at'
    sortInfo.sort_order = 'desc'
  }
  loadData(true)
}



const handleCurrentChange = (page: number) => {
  pagination.page = page
  loadData(true)
}

const viewReport = (row: MergeRequestListItem) => {
  // Ë∑≥ËΩ¨Âà∞ÂÆ°Êü•ËØ¶ÊÉÖÈ°µÈù¢
  if (row.review_id) {
    // ‰øùÂ≠òÂΩìÂâçÂàÜÈ°µÁä∂ÊÄÅ
    savePaginationState()
    router.push(`/admin/review/${row.review_id}`)
  } else {
    ElMessage.warning('ËØ•ÂêàÂπ∂ËØ∑Ê±ÇÊöÇÊó†ÂÆ°Êü•Êä•Âëä')
  }
}

const showReviewReport = (row: MergeRequestListItem) => {
  // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂÆåÊï¥Êä•ÂëäÁïåÈù¢
  if (row.review_id && row.review_id > 0) {
    // ‰øùÂ≠òÂΩìÂâçÂàÜÈ°µÁä∂ÊÄÅ
    savePaginationState()
    router.push(`/admin/review/${row.review_id}`)
  } else {
    if (row.review_status === 'Êú™ÂÆ°Êü•') {
      ElMessage.warning('ËØ•ÂêàÂπ∂ËØ∑Ê±ÇÂ∞öÊú™ËøõË°å‰ª£Á†ÅÂÆ°Êü•ÔºåËØ∑ÂÖàÁÇπÂáª"‰ª£Á†ÅÂÆ°Êü•"ÊåâÈíÆ')
    } else if (row.review_status === 'ÂÆ°Êü•ËøõË°å‰∏≠') {
      ElMessage.info('ÂÆ°Êü•Ê≠£Âú®ËøõË°å‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï')
    } else if (row.review_status === 'ÂÆ°Êü•Â§±Ë¥•') {
      ElMessage.error('ÂÆ°Êü•Â§±Ë¥•ÔºåËØ∑ÈáçÊñ∞Ëß¶ÂèëÂÆ°Êü•')
    } else {
      ElMessage.warning('ËØ•ÂêàÂπ∂ËØ∑Ê±ÇÊöÇÊó†ÂÆ°Êü•Êä•Âëä')
    }
  }
}



// Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÂÆ°Êü•
const canReview = (row: MergeRequestListItem) => {
  // Â¶ÇÊûúÊ≠£Âú®ÂÆ°Êü•‰∏≠ÔºåÂàô‰∏çÂèØÁÇπÂáª
  if (reviewingIds.value.has(row.id)) {
    return false
  }
  
  // Â¶ÇÊûúÂêéÁ´ØÊòæÁ§∫Ê≠£Âú®ÂÆ°Êü•‰∏≠Ôºå‰πü‰∏çÂèØÁÇπÂáªÔºàÈÅøÂÖçÊòæÁ§∫‰∏ãÊãâÁÆ≠Â§¥Ôºâ
  if (row.is_reviewing === 1) {
    return false
  }
  
  return true
}


// Â§ÑÁêÜÂÆ°Êü•‰∏ãÊãâËèúÂçïÂëΩ‰ª§
const handleReviewCommand = async (command: string, row: MergeRequestListItem) => {
  // Â¶ÇÊûúÊ≠£Âú®ÂÆ°Êü•‰∏≠Ôºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
  if (reviewingIds.value.has(row.id)) {
    return
  }
  
  // Â¶ÇÊûúÂêéÁ´ØÊòæÁ§∫Ê≠£Âú®ÂÆ°Êü•‰∏≠ÔºåÊòæÁ§∫Âº∫Âà∂ÂÆ°Êü•Ë≠¶Âëä
  if (row.is_reviewing === 1) {
    try {
      await ElMessageBox.confirm(
        `ÂêàÂπ∂ËØ∑Ê±Ç ${row.gitlab_id} Ê≠£Âú®ÂÆ°Êü•‰∏≠ÔºåÂº∫Âà∂ÈáçÊñ∞ÂÆ°Êü•Â∞Ü‰∏≠Êñ≠ÂΩìÂâçÂÆ°Êü•„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü`,
        'Âº∫Âà∂ÂÆ°Êü•Ë≠¶Âëä',
        {
          confirmButtonText: 'Âº∫Âà∂ÂÆ°Êü•',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning',
        }
      )
    } catch (error) {
      // Áî®Êà∑ÂèñÊ∂à
      return
    }
  }
  
  if (command === 'direct') {
    // Áõ¥Êé•ÂÆ°Êü•
    await executeReview(row, { force: row.is_reviewing === 1 })
  } else if (command === 'custom') {
    // Ëá™ÂÆö‰πâÂÆ°Êü•ÔºåÁõ¥Êé•ÊòæÁ§∫Ëá™ÂÆö‰πâÂÆ°Êü•ÂØπËØùÊ°Ü
    currentReviewMR.value = row
    showCustomReviewDialog.value = true
  }
}

// ÊâßË°åÂÆ°Êü•
const executeReview = async (row: MergeRequestListItem, options: {
  force: boolean
  template_id?: number
  custom_instructions?: string
}) => {
  try {
    reviewingIds.value.add(row.id)
    const result = await adminApi.triggerReview(row.id, options)
    
    // Ê£ÄÊü•ÊòØÂê¶ÊàêÂäüÂêØÂä®ÂÆ°Êü•
    if (result.success) {
      ElMessage.success(result.message || '‰ª£Á†ÅÂÆ°Êü•Â∑≤ÂêØÂä®ÔºåÊ≠£Âú®Â§ÑÁêÜ‰∏≠...')
      
      // Á´ãÂç≥Âà∑Êñ∞Êï∞ÊçÆÔºåÊòæÁ§∫ÂÆ°Êü•‰∏≠Áä∂ÊÄÅ
      await loadData(true)
      
      // ÂêØÂä®Áä∂ÊÄÅËΩÆËØ¢
      startPollingForReviewStatus(row.id)
    } else {
      ElMessage.error(result.message || 'ÂêØÂä®‰ª£Á†ÅÂÆ°Êü•Â§±Ë¥•')
    }
  } catch (error: any) {
    if (error.response?.status === 409) {
      ElMessage.warning('ËØ•ÂêàÂπ∂ËØ∑Ê±ÇÊ≠£Âú®ÂÆ°Êü•‰∏≠ÔºåËØ∑Á®çÂêéÂÜçËØï')
    } else {
      ElMessage.error('Êìç‰ΩúÂ§±Ë¥•')
    }
  } finally {
    reviewingIds.value.delete(row.id)
  }
}

// Â§ÑÁêÜËá™ÂÆö‰πâÂÆ°Êü•Á°ÆËÆ§
const handleCustomReviewConfirm = async (options: {
  force: boolean
  template_id?: number
  custom_instructions?: string
}) => {
  if (!currentReviewMR.value) return
  
  const row = currentReviewMR.value
  await executeReview(row, options)
}

const handleSync = async (row: MergeRequestListItem) => {
  try {
    syncingIds.value.add(row.id)
    const result = await adminApi.syncSingleMergeRequest(row.id)
    
    if (result.success) {
      // ÂêåÊ≠•ÊâßË°åÂÆåÊàêÔºåÁõ¥Êé•ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆÔºå‰∏çÊòæÁ§∫ÂºπÁ™ó
      await loadData(true)
    } else {
      ElMessage.error(result.message || 'ÂêåÊ≠•Â§±Ë¥•')
    }
  } catch (error) {
    console.error('ÂêåÊ≠•Â§±Ë¥•:', error)
    ElMessage.error('ÂêåÊ≠•Â§±Ë¥•')
  } finally {
    syncingIds.value.delete(row.id)
  }
}

// ‰ªªÂä°Áä∂ÊÄÅËΩÆËØ¢
const pollTaskStatus = async (taskId: string) => {
  try {
    const response = await adminApi.getTaskStatus(taskId)
    
    if (response.success) {
      const { status, progress, message, result, error } = response
      
      // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
      taskStatuses.value.set(taskId, { status, progress, message })
      
      // Âè™Âú®‰ªªÂä°ÂÆåÊàêÊàñÂ§±Ë¥•Êó∂ÊòæÁ§∫Ê∂àÊÅØÔºåÈÅøÂÖçÈ¢ëÁπÅÂºπÁ™ó
      if (status === 'completed') {
        ElMessage.success('ÂêåÊ≠•‰ªªÂä°ÂÆåÊàê')
        // Ê∏ÖÈô§ËΩÆËØ¢ÂíåÁä∂ÊÄÅ
        clearTaskPolling(taskId)
        taskStatuses.value.delete(taskId)
        // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        await loadData(true)
      } else if (status === 'failed') {
        ElMessage.error(`ÂêåÊ≠•‰ªªÂä°Â§±Ë¥•: ${error || message}`)
        // Ê∏ÖÈô§ËΩÆËØ¢ÂíåÁä∂ÊÄÅ
        clearTaskPolling(taskId)
        taskStatuses.value.delete(taskId)
      } else if (status === 'cancelled') {
        ElMessage.warning('ÂêåÊ≠•‰ªªÂä°Â∑≤ÂèñÊ∂à')
        // Ê∏ÖÈô§ËΩÆËØ¢ÂíåÁä∂ÊÄÅ
        clearTaskPolling(taskId)
        taskStatuses.value.delete(taskId)
      }
      
      // Â¶ÇÊûú‰ªªÂä°ËøòÂú®ËøêË°åÔºåÁªßÁª≠ËΩÆËØ¢
      if (status === 'running' || status === 'pending') {
        const intervalId = setTimeout(() => {
          pollTaskStatus(taskId)
        }, 3000) // ÊØè3ÁßíËΩÆËØ¢‰∏ÄÊ¨°ÔºåÂáèÂ∞ëÈ¢ëÁéá
        taskPollingIntervals.set(taskId, intervalId)
      }
    }
  } catch (error) {
    console.error('Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•:', error)
    ElMessage.error('Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•')
    clearTaskPolling(taskId)
    taskStatuses.value.delete(taskId)
  }
}

const clearTaskPolling = (taskId: string) => {
  const intervalId = taskPollingIntervals.get(taskId)
  if (intervalId) {
    clearTimeout(intervalId)
    taskPollingIntervals.delete(taskId)
  }
}

const getReviewStatusClass = (row: any) => {
  if (row.is_reviewing === 1) return 'status-reviewing'
  if (row.is_failed === 1) return 'status-error'  // Ê∑ªÂä†Â§±Ë¥•Áä∂ÊÄÅÊ†∑Âºè
  if (row.is_reviewed === 0) return 'status-pending'
  if (row.is_reviewed === 1 && row.is_latest_reviewed === 1) return 'status-success'
  if (row.is_reviewed === 1 && row.is_latest_reviewed === 0) return 'status-warning'
  return 'status-info'
}

const getReviewStatusText = (row: any) => {
  if (row.is_reviewing === 1) return 'ÂÆ°Êü•‰∏≠'
  if (row.is_failed === 1) return 'ÂÆ°Êü•Â§±Ë¥•'  // Ê∑ªÂä†Â§±Ë¥•Áä∂ÊÄÅÊñáÊú¨
  if (row.is_reviewed === 0) return 'Êú™ÂÆ°Êü•'
  if (row.is_reviewed === 1) return 'Â∑≤ÂÆ°Êü•'
  return 'Êú™ÂÆ°Êü•'
}

const getReviewStatusDesc = (row: any) => {
  if (row.is_reviewing === 1) return 'Ê≠£Âú®ÂÆ°Êü•‰∏≠'
  if (row.is_failed === 1) return 'ÂÆ°Êü•Â§±Ë¥•'  // Ê∑ªÂä†Â§±Ë¥•Áä∂ÊÄÅÊèèËø∞
  if (row.is_reviewed === 0) return 'Á≠âÂæÖÂÆ°Êü•'
  if (row.is_reviewed === 1 && row.is_latest_reviewed === 1) return 'ÂÆ°Êü•ÊúÄÊñ∞'
  if (row.is_reviewed === 1 && row.is_latest_reviewed === 0) return 'ÂÆ°Êü•ËøáÊó∂'
  return 'Á≠âÂæÖÂÆ°Êü•'
}

// Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆ°Êü•‰∏≠ÁöÑËÆ∞ÂΩï
const hasReviewingRecord = (row: any) => {
  // ËøôÈáåÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÊï∞ÊçÆÁªìÊûÑÊù•Âà§Êñ≠
  // ÊöÇÊó∂ËøîÂõûfalseÔºåÂêéÁª≠ÂèØ‰ª•ÈÄöËøáAPIËé∑Âèñ
  return false
}

// Êõ¥Êñ∞Âçï‰∏™MRÁöÑÁä∂ÊÄÅ
const updateSingleMRStatus = async (mrId: number) => {
  try {
    const statusData = await adminApi.getMergeRequestStatus(mrId)
    
    // ÊâæÂà∞ÂØπÂ∫îÁöÑË°åÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ
    const mrIndex = tableData.value.findIndex(item => item.id === mrId)
    if (mrIndex !== -1) {
      const currentMR = tableData.value[mrIndex]
      
      // Ê£ÄÊü•Áä∂ÊÄÅÊòØÂê¶ÁúüÁöÑÂèëÁîü‰∫ÜÂèòÂåñ
      const hasChanged = (
        currentMR.is_reviewing !== statusData.is_reviewing ||
        currentMR.is_reviewed !== statusData.is_reviewed ||
        currentMR.is_latest_reviewed !== statusData.is_latest_reviewed ||
        currentMR.is_failed !== statusData.is_failed ||
        currentMR.review_status !== statusData.review_status ||
        currentMR.review_score !== statusData.review_score ||
        currentMR.last_commit_sha !== statusData.last_commit_sha ||
        currentMR.state !== statusData.state
      )
      
      if (hasChanged) {
        // Âè™Êõ¥Êñ∞ÂèòÂåñÁöÑÂ≠óÊÆµÔºåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÈáçÊñ∞Ê∏≤Êüì
        tableData.value[mrIndex] = {
          ...currentMR,
          is_reviewing: statusData.is_reviewing,
          is_reviewed: statusData.is_reviewed,
          is_latest_reviewed: statusData.is_latest_reviewed,
          is_failed: statusData.is_failed,
          review_status: statusData.review_status,
          review_score: statusData.review_score,
          last_commit_sha: statusData.last_commit_sha,
          state: statusData.state,
          review_id: statusData.review_id,
          mr_updated_at: statusData.mr_updated_at || currentMR.mr_updated_at
        }
        
        console.log(`MR ${mrId} Áä∂ÊÄÅÂ∑≤Êõ¥Êñ∞:`, {
          is_reviewing: statusData.is_reviewing,
          review_status: statusData.review_status,
          review_score: statusData.review_score
        })
      }
    }
  } catch (error) {
    console.error(`Êõ¥Êñ∞MR ${mrId} Áä∂ÊÄÅÂ§±Ë¥•:`, error)
  }
}

// ÂêØÂä®ÂÆöÊó∂Âà∑Êñ∞ÂÆ°Êü•Áä∂ÊÄÅ
const startPollingForReviewStatus = (mrId: number) => {
  // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
  stopPollingForReviewStatus(mrId)
  
  // ÈáçÁΩÆËΩÆËØ¢ËÆ°Êï∞
  pollingCounts.value.set(mrId, 0)
  
  // ÂêØÂä®Êñ∞ÁöÑÂÆöÊó∂Âô®ÔºåÊØè3ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
  const interval = setInterval(async () => {
    try {
      // Â¢ûÂä†ËΩÆËØ¢ËÆ°Êï∞
      const currentCount = pollingCounts.value.get(mrId) || 0
      pollingCounts.value.set(mrId, currentCount + 1)
      
      // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøáÊúÄÂ§ßËΩÆËØ¢Ê¨°Êï∞
      if (currentCount >= maxPollingCount) {
        console.warn(`MR ${mrId} ËΩÆËØ¢Ë∂ÖÊó∂ÔºåÂÅúÊ≠¢ËΩÆËØ¢`)
        stopPollingForReviewStatus(mrId)
        return
      }
      
      // Âè™Êü•ËØ¢Âçï‰∏™MRÁöÑÁä∂ÊÄÅÔºåÈÅøÂÖçÂÖ®Ë°®Âà∑Êñ∞
      await updateSingleMRStatus(mrId)
      
      // Ê£ÄÊü•ËØ•MRÊòØÂê¶ËøòÂú®ÂÆ°Êü•‰∏≠
      const mr = tableData.value.find(item => item.id === mrId)
      if (mr && mr.is_reviewing !== 1) {
        // Â¶ÇÊûú‰∏çÂÜçÂÆ°Êü•‰∏≠ÔºåÂÅúÊ≠¢ÂÆöÊó∂Âà∑Êñ∞
        console.log(`MR ${mrId} ÂÆ°Êü•ÂÆåÊàêÔºåÂÅúÊ≠¢ËΩÆËØ¢`)
        stopPollingForReviewStatus(mrId)
      }
    } catch (error) {
      console.error('ÂÆöÊó∂Âà∑Êñ∞Â§±Ë¥•:', error)
      stopPollingForReviewStatus(mrId)
    }
  }, 3000)
  
  pollingIntervals.value.set(mrId, interval)
  console.log(`ÂºÄÂßãËΩÆËØ¢MR ${mrId} ÁöÑÂÆ°Êü•Áä∂ÊÄÅ`)
}

// ÂÅúÊ≠¢ÂÆöÊó∂Âà∑Êñ∞
const stopPollingForReviewStatus = (mrId: number) => {
  const interval = pollingIntervals.value.get(mrId)
  if (interval) {
    clearInterval(interval)
    pollingIntervals.value.delete(mrId)
    pollingCounts.value.delete(mrId)
    console.log(`ÂÅúÊ≠¢ËΩÆËØ¢MR ${mrId} ÁöÑÂÆ°Êü•Áä∂ÊÄÅ`)
  }
}

// Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
const clearAllPolling = () => {
  pollingIntervals.value.forEach((interval) => {
    clearInterval(interval)
  })
  pollingIntervals.value.clear()
  pollingCounts.value.clear()
}



const getScoreClass = (score: number) => {
  if (score >= 80) return 'score-excellent'
  if (score >= 60) return 'score-good'
  return 'score-poor'
}

const getStateType = (state: string) => {
  const types: Record<string, string> = {
    opened: 'success',  // ÂºÄÂèëÁä∂ÊÄÅÊîπ‰∏∫ÁªøËâ≤
    closed: 'info',     // ÂÖ≥Èó≠Áä∂ÊÄÅ‰øùÊåÅÁÅ∞Ëâ≤
    merged: 'primary'   // ÂêàÂπ∂Áä∂ÊÄÅÊîπ‰∏∫ËìùËâ≤
  }
  return types[state] || 'info'
}

const getStateText = (state: string) => {
  const texts: Record<string, string> = {
    opened: 'ÂºÄÂèë',
    closed: 'ÂÖ≥Èó≠',
    merged: 'ÂêàÂπ∂'
  }
  return texts[state] || state
}

const formatDate = (dateStr: string) => {
  return dayjs(dateStr).format('YYYY-MM-DD HH:mm:ss')
}

// ËÆ°ÁÆóË°®Ê†ºÊúÄÂ§ßÈ´òÂ∫¶
const calculateTableHeight = () => {
  // ËÆ°ÁÆó10Êù°Êï∞ÊçÆÁöÑÈ´òÂ∫¶ÔºöË°®Â§¥(40px) + 10Ë°åÊï∞ÊçÆ(ÊØèË°å50px)
  const tableContentHeight = 60 + (11 * 60)
  // ËÆæÁΩÆË°®Ê†ºÊúÄÂ§ßÈ´òÂ∫¶‰∏∫10Êù°Êï∞ÊçÆÁöÑÈ´òÂ∫¶
  tableMaxHeight.value = tableContentHeight
}

onMounted(async () => {
  await loadProjects()
  
  // Â∞ùËØïÊÅ¢Â§çÂàÜÈ°µÁä∂ÊÄÅÔºåÂ¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÁä∂ÊÄÅÂàô‰ΩøÁî®ÈªòËÆ§ÁöÑÈ°πÁõÆÈÄâÊã©
  const hasRestoredState = restorePaginationState()
  if (!hasRestoredState) {
    loadSelectedProject()
  }
  
  loadData(true)
  
  // ËÆ°ÁÆóË°®Ê†ºÈ´òÂ∫¶
  calculateTableHeight()
  
  // ÁõëÂê¨Á™óÂè£Â§ßÂ∞èÂèòÂåñ
  window.addEventListener('resize', calculateTableHeight)
})

onUnmounted(() => {
  // Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®
  clearAllPolling()
  
  // ÁßªÈô§Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
  window.removeEventListener('resize', calculateTableHeight)
})
</script>

<style scoped>
.merge-requests-container {
  padding: 16px 24px 24px 24px;
  background: #f5f7fa;
  min-height: 96vh;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

.page-header {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom: 16px;
  flex-shrink: 0;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.project-selector-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #e9ecef;
  position: relative;
  flex-shrink: 0;
}

.project-selector-content {
  position: relative;
  z-index: 1;
  display: flex;
  align-items: center;
  gap: 20px;
}

.selector-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #606266;
  min-width: 90px;
  font-size: 14px;
  white-space: nowrap;
}

.label-icon {
  font-size: 16px;
  color: #909399;
}

.modern-project-select {
  min-width: 320px;
  flex: 1;
}

.modern-project-select :deep(.el-input__wrapper) {
  background: #ffffff;
  border: 1px solid #dcdfe6;
  border-radius: 6px;
  transition: all 0.3s ease;
  height: 40px;
}

.modern-project-select :deep(.el-input__wrapper:hover) {
  border-color: #409eff;
}

.modern-project-select :deep(.el-input__inner) {
  color: #303133;
  font-weight: 500;
  font-size: 14px;
  line-height: 44px;
}

.modern-project-select :deep(.el-input__inner::placeholder) {
  color: #909399;
  font-weight: 400;
}

.project-option {
  padding: 12px 16px;
  transition: all 0.2s ease;
  line-height: 1.4;
  min-height: 48px;
}

.project-option:hover {
  background: linear-gradient(135deg, #f5f7fa 0%, #e3f2fd 100%);
}

.project-option-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  min-height: 24px;
}

.project-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.project-name {
  font-weight: 600;
  color: #303133;
  margin-bottom: 4px;
  font-size: 14px;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.project-meta {
  display: flex;
  align-items: center;
}

.project-id {
  color: #909399;
  font-size: 12px;
  font-weight: 500;
  line-height: 1.2;
}

.project-indicator {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  margin-left: 8px;
}

.indicator-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #409eff;
  opacity: 0;
  transition: all 0.3s ease;
}

.project-option:hover .indicator-dot {
  opacity: 1;
  transform: scale(1.3);
}

.filter-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  border: 1px solid #e9ecef;
  /* Èò≤Ê≠¢Á≠õÈÄâÊ†èÈó™ÁÉÅ */
  min-height: 80px;
  position: relative;
  z-index: 1;
}

.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  align-items: center;
  min-height: 48px;
}

.filter-item {
  min-width: 180px;
  /* Èò≤Ê≠¢Á≠õÈÄâÈ°πÈó™ÁÉÅ */
  position: relative;
  z-index: 2;
}

.filter-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
  grid-column: span 2;
  justify-content: flex-end;
}

.compact-input :deep(.el-input__wrapper) {
  background: white;
  border: 1px solid #dcdfe6;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.compact-input :deep(.el-input__wrapper:hover) {
  border-color: #409eff;
}

.compact-input :deep(.el-input__wrapper.is-focus) {
  border-color: #409eff;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
}

.compact-input :deep(.el-select .el-input__wrapper) {
  background: white;
  border: 1px solid #dcdfe6;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.compact-input :deep(.el-select .el-input__wrapper:hover) {
  border-color: #409eff;
}

.compact-input :deep(.el-select .el-input__wrapper.is-focus) {
  border-color: #409eff;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
}

.filter-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.table-card {
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  flex: 1;
  display: flex;
  flex-direction: column;
}

.modern-table {
  border-radius: 8px;
  overflow: hidden;
}

/* Ë°®Ê†ºÊªöÂä®‰ºòÂåñ */
:deep(.el-table__body-wrapper) {
  overflow-y: auto;
  overflow-x: auto;
}

:deep(.el-table__body-wrapper::-webkit-scrollbar) {
  width: 8px;
  height: 8px;
}

:deep(.el-table__body-wrapper::-webkit-scrollbar-track) {
  background: #f1f1f1;
  border-radius: 4px;
}

:deep(.el-table__body-wrapper::-webkit-scrollbar-thumb) {
  background: #c1c1c1;
  border-radius: 4px;
}

:deep(.el-table__body-wrapper::-webkit-scrollbar-thumb:hover) {
  background: #a8a8a8;
}

/* Âõ∫ÂÆöÂàóÊ†∑Âºè‰ºòÂåñ */
:deep(.el-table__fixed) {
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
}

:deep(.el-table__fixed-right) {
  box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
}

/* Ë°®Ê†ºË°åÊÇ¨ÂÅúÊïàÊûú */
:deep(.el-table__body tr:hover > td) {
  background-color: #f8f9fa !important;
}

/* ÊñëÈ©¨Á∫πÊ†∑Âºè‰ºòÂåñ */
:deep(.el-table__body tr:nth-child(even)) {
  background-color: #fafbfc;
}

/* Ë°®Ê†ºË°åÈ´òÂ∫¶‰ºòÂåñ */
:deep(.el-table__body tr) {
  height: 50px;
}

:deep(.el-table__header tr) {
  height: 40px;
}

/* Á°Æ‰øùË°®Ê†ºÂÜÖÂÆπÂûÇÁõ¥Â±Ö‰∏≠ */
:deep(.el-table__body td) {
  padding: 8px 0;
  vertical-align: middle;
}

:deep(.el-table__header th) {
  padding: 8px 0;
  vertical-align: middle;
}

.status-cell {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 0;
  transition: all 0.2s ease;
  min-width: 0; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
  width: 100%;
  justify-content: center; /* Êîπ‰∏∫Â±Ö‰∏≠ÂØπÈΩêÔºå‰øùÊåÅÊï¥‰ΩìÂ∏ÉÂ±ÄÁ®≥ÂÆö */
  position: relative; /* ‰∏∫ÁªùÂØπÂÆö‰ΩçÁöÑÂ≠êÂÖÉÁ¥†Êèê‰æõÂèÇËÄÉ */
}

.status-cell.clickable {
  cursor: pointer;
  border-radius: 6px;
  padding: 4px 8px;
  transition: all 0.2s ease;
}

.status-cell.clickable:hover {
  background: rgba(64, 158, 255, 0.1);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.status-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  font-size: 14px;
  color: white;
  flex-shrink: 0; /* Èò≤Ê≠¢ÂõæÊ†áË¢´ÂéãÁº© */
  flex-grow: 0; /* Èò≤Ê≠¢ÂõæÊ†áË¢´Êãâ‰º∏ */
  position: absolute; /* ‰ΩøÁî®ÁªùÂØπÂÆö‰ΩçÁ°Æ‰øù‰ΩçÁΩÆÂõ∫ÂÆö */
  left: 10px; /* Ë∑ùÁ¶ªÂ∑¶‰æß10pxÔºå‰øùÊåÅÈÄÇÂΩìÈó¥Ë∑ù */
  top: 50%; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
  transform: translateY(-50%); /* Á≤æÁ°ÆÂûÇÁõ¥Â±Ö‰∏≠ */
}

.status-reviewing {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  animation: pulse 2s infinite;
}

.status-pending {
  background: linear-gradient(135deg, #ff9a56, #ff6b6b);
}

.status-success {
  background: linear-gradient(135deg, #4ecdc4, #44a08d);
}

.status-warning {
  background: linear-gradient(135deg, #ffd93d, #ff6b6b);
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.status-error {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
}

.status-info {
  background: linear-gradient(135deg, #a8edea, #fed6e3);
}

.status-text {
  flex: 1;
  min-width: 0; /* Èò≤Ê≠¢flexÂ≠êÂÖÉÁ¥†Ê∫¢Âá∫ */
  display: flex;
  flex-direction: column;
  justify-content: center;
  text-align: center; /* Êîπ‰∏∫Â±Ö‰∏≠ÂØπÈΩêÔºå‰øùÊåÅÊñáÂ≠ó‰ΩçÁΩÆÁ®≥ÂÆö */
  margin-left: 44px; /* ‰∏∫ÁªùÂØπÂÆö‰ΩçÁöÑÂõæÊ†áÁïôÂá∫Á©∫Èó¥ (10px + 28px + 6px) */
  width: calc(100% - 44px); /* Âõ∫ÂÆöÂÆΩÂ∫¶ÔºåÂáèÂéªÂõæÊ†áÂç†Áî®ÁöÑÁ©∫Èó¥ */
  position: relative; /* ‰∏∫ÂÜÖÈÉ®ÂÖÉÁ¥†Êèê‰æõÂÆö‰ΩçÂèÇËÄÉ */
}

.status-label {
  font-weight: 600;
  font-size: 13px;
  color: #303133;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%; /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
  text-align: center; /* Â±Ö‰∏≠ÂØπÈΩê */
}

.status-desc {
  font-size: 11px;
  color: #909399;
  line-height: 1.2;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%; /* Âõ∫ÂÆöÂÆΩÂ∫¶ */
  text-align: center; /* Â±Ö‰∏≠ÂØπÈΩê */
}



.score-cell {
  display: flex;
  align-items: center;
  justify-content: center;
}

.score-badge {
  display: flex;
  align-items: center;
  padding: 6px 12px;
  border-radius: 16px;
  font-weight: 600;
  font-size: 14px;
  color: white;
  min-width: 50px;
  justify-content: center;
  position: relative;
  transition: all 0.2s ease;
}

.score-badge.clickable {
  cursor: pointer;
  padding-right: 28px;
  transition: all 0.2s ease;
}

.score-badge.clickable:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.score-icon {
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 12px;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.score-badge.clickable:hover .score-icon {
  opacity: 1;
}

.score-excellent {
  background: #10b981;
}

.score-good {
  background: #f59e0b;
}

.score-poor {
  background: #ef4444;
}

.score-value {
  font-size: 14px;
  font-weight: 600;
}

.score-empty {
  color: #c0c4cc;
  font-size: 16px;
}

.state-tag {
  border-radius: 12px;
  font-weight: 500;
  font-size: 12px;
  padding: 4px 8px;
  border: none;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Ëá™ÂÆö‰πâÁä∂ÊÄÅÈ¢úËâ≤ */
.state-tag.el-tag--success {
  background: linear-gradient(135deg, #67c23a 0%, #85ce61 100%);
  color: white;
}

.state-tag.el-tag--primary {
  background: linear-gradient(135deg, #409eff 0%, #66b1ff 100%);
  color: white;
}

.state-tag.el-tag--info {
  background: linear-gradient(135deg, #909399 0%, #a6a9ad 100%);
  color: white;
}

.action-buttons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}

.action-btn {
  border-radius: 6px;
  font-weight: 500;
}

.additions {
  color: #67c23a;
  font-weight: 500;
  margin-right: 4px;
}

.deletions {
  color: #f56c6c;
  font-weight: 500;
}

.no-changes {
  color: #909399;
  font-style: italic;
}

.pagination-container {
  margin-top: 24px;
  padding-top: 24px;
  border-top: 1px solid #e4e7ed;
}

.pagination-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 32px;
}

.pagination-info {
  display: flex;
  align-items: center;
}

.pagination-text {
  font-size: 14px;
  color: #606266;
  font-weight: 500;
}

.pagination-controls {
  display: flex;
  align-items: center;
  gap: 16px;
}

.pagination-sizes-wrapper {
  display: flex;
  align-items: center;
  gap: 4px;
}

.page-size-select {
  width: 80px;
}

.page-size-select :deep(.el-input__wrapper) {
  border-radius: 6px;
  border: 1px solid #dcdfe6;
}

.page-size-select :deep(.el-input__wrapper:hover) {
  border-color: #409eff;
}

.page-size-select :deep(.el-input__inner) {
  text-align: center;
  padding-right: 8px;
}

.page-size-select :deep(.el-input__suffix) {
  display: none;
}

.page-size-unit {
  font-size: 14px;
  color: #606266;
  font-weight: 500;
}

.modern-pagination {
  --el-pagination-bg-color: transparent;
  --el-pagination-border-radius: 8px;
}

.modern-pagination :deep(.el-pagination__sizes) {
  margin-right: 16px;
}

.modern-pagination :deep(.el-pagination__total) {
  margin-right: 16px;
}

.modern-pagination :deep(.el-pagination__jump) {
  margin-left: 16px;
}

.modern-pagination :deep(.el-select .el-input) {
  width: 100px;
}

.modern-pagination :deep(.el-pagination__jump .el-input) {
  width: 50px;
}

.modern-pagination :deep(.el-pagination__sizes .el-select .el-input__inner) {
  text-align: center;
  padding-right: 8px;
}

.modern-pagination :deep(.el-pagination__sizes .el-select .el-input__suffix) {
  display: none;
}

.modern-pagination :deep(.el-pagination__sizes .el-select .el-input__wrapper) {
  border-radius: 6px;
}

.modern-pagination :deep(.el-pagination__sizes .el-select .el-input__wrapper:hover) {
  border-color: #409eff;
}

:deep(.el-table) {
  border-radius: 8px;
  overflow: hidden;
  flex: 1;
}

:deep(.el-table th) {
  background: #f8f9fa !important;
  border-bottom: 1px solid #e4e7ed;
}

:deep(.el-table td) {
  border-bottom: 1px solid #f0f0f0;
}

:deep(.el-table--enable-row-hover .el-table__body tr:hover > td) {
  background: #f5f7fa;
}

:deep(.el-card__body) {
  padding: 20px;
}

:deep(.el-form--inline .el-form-item) {
  margin-right: 16px;
  margin-bottom: 16px;
}

:deep(.el-button) {
  border-radius: 6px;
  font-weight: 500;
}

:deep(.el-input__wrapper) {
  border-radius: 6px;
}

:deep(.el-pagination .el-pager li) {
  border-radius: 6px;
}

.mr-id-cell {
  display: flex;
  align-items: center;
  justify-content: center;
}

.mr-id-link {
  display: flex;
  align-items: center;
  gap: 4px;
  color: #409eff;
  cursor: pointer;
  font-weight: 500;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
  position: relative;
}

.mr-id-link:hover {
  background: rgba(64, 158, 255, 0.1);
  color: #66b1ff;
  transform: translateY(-1px);
}

.link-icon {
  font-size: 12px;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.mr-id-link:hover .link-icon {
  opacity: 1;
}

.sync-project-btn {
  margin-left: 12px;
  transition: all 0.3s ease;
  background: #409eff;
  border: 1px solid #409eff;
  color: white;
  font-weight: 500;
  border-radius: 6px;
  height: 40px;
  padding: 0 16px;
}

.sync-project-btn:hover {
  background: #66b1ff;
  border-color: #66b1ff;
}

.sync-project-btn:active {
  background: #3a8ee6;
  border-color: #3a8ee6;
}

.commit-id-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #303133;
  font-weight: 500;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.commit-id-cell:hover {
  background: rgba(64, 158, 255, 0.1);
  color: #66b1ff;
  transform: translateY(-1px);
}

.commit-id-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.no-commit {
  color: #909399;
  font-style: italic;
}


/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .filter-grid {
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }
  
  .filter-actions {
    grid-column: span 1;
  }
  
  .project-selector-content {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }
  
  .modern-project-select {
    width: 100%;
  }
  
  .sync-project-btn {
    margin-left: 0;
    width: 100%;
  }
}

@media (max-width: 768px) {
  .merge-requests-container {
    padding: 16px;
  }
  
  .filter-grid {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .filter-actions {
    grid-column: span 1;
    justify-content: stretch;
  }
  
  .filter-actions .el-button {
    flex: 1;
  }
  
  .project-selector-container {
    padding: 12px;
  }
  
  .project-selector-content {
    gap: 8px;
  }
  
  .selector-label {
    font-size: 14px;
  }
  
  .table-card {
    margin-top: 16px;
  }
  
  :deep(.el-table) {
    font-size: 12px;
  }
  
  :deep(.el-table th) {
    padding: 8px 4px;
  }
  
  :deep(.el-table td) {
    padding: 8px 4px;
  }
  
  .mr-id-link {
    padding: 2px 4px;
    font-size: 12px;
  }
  
  .score-badge {
    padding: 4px 8px;
    font-size: 12px;
    min-width: 40px;
  }
  
  .state-tag {
    font-size: 10px;
    padding: 2px 6px;
  }
}

@media (max-width: 480px) {
  .merge-requests-container {
    padding: 12px;
  }
  
  .filter-container {
    padding: 12px;
  }
  
  .filter-grid {
    gap: 8px;
  }
  
  .project-selector-container {
    padding: 8px;
  }
  
  .project-selector-content {
    gap: 6px;
  }
  
  .selector-label {
    font-size: 13px;
  }
  
  .table-card {
    margin-top: 12px;
  }
  
  :deep(.el-table) {
    font-size: 11px;
  }
  
  :deep(.el-table th) {
    padding: 6px 2px;
  }
  
  :deep(.el-table td) {
    padding: 6px 2px;
  }
  
  .mr-id-link {
    padding: 1px 3px;
    font-size: 11px;
  }
  
  .score-badge {
    padding: 3px 6px;
    font-size: 11px;
    min-width: 35px;
  }
  
  .state-tag {
    font-size: 9px;
    padding: 1px 4px;
  }
  
  /* ÂÆ°Êü•Áä∂ÊÄÅ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
  .status-cell {
    position: relative;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
  }
  
  .status-cell.clickable {
    cursor: pointer;
  }
  
  .status-cell.clickable:hover {
    background-color: #f0f9ff;
    border-color: #409eff;
  }
  
  .status-cell.reviewing {
    background-color: #fff7e6;
    border: 1px solid #ffd591;
  }
  
  .status-cell.reviewing:hover {
    background-color: #fff2e8;
    border-color: #ffa940;
  }
  
  
  :deep(.el-dropdown-menu__item) {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  :deep(.el-dropdown-menu__item .el-icon) {
    font-size: 14px;
  }
}
</style>
